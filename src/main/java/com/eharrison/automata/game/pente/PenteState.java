package com.eharrison.automata.game.pente;

import com.eharrison.automata.game.State;
import com.eharrison.automata.game.pente.bot.PenteBot;
import lombok.val;

import java.util.UUID;

public record PenteState(
        int round,
        PenteBot bot1,
        PenteBot bot2,
        UUID[][] board,
        PenteAction lastAction,
        int bot1Captures,
        int bot2Captures,
        PenteBot currentBot
) implements State<PenteBot> {
    public PenteState(final PenteBot bot1, final PenteBot bot2, final UUID[][] board, final boolean bot1Starts) {
        this(0, bot1, bot2, board, null, 0, 0, bot1Starts ? bot1 : bot2);
    }

    @Override
    public PenteView viewFor(final PenteBot bot) {
        val opponent = currentBot == bot1 ? bot2 : bot1;
        return new PenteView(round, opponent.getId(), board.clone(), lastAction);
    }

    public PenteState next(final UUID[][] newBoard, final int captures, final PenteAction lastAction) {
        return new PenteState(
                round + 1,
                bot1,
                bot2,
                newBoard,
                lastAction,
                currentBot == bot1 ? bot1Captures + captures : bot1Captures,
                currentBot == bot2 ? bot2Captures + captures : bot2Captures,
                currentBot == bot1 ? bot2 : bot1
        );
    }

    public String display() {
        val sb = new StringBuilder();
        for (val cells : board) {
            for (int c = 0; c < cells.length; c++) {
                if (cells[c] == null) {
                    sb.append(".");
                } else if (bot1.getId().equals(cells[c])) {
                    sb.append("X");
                } else {
                    sb.append("O");
                }
                if (c < cells.length - 1) {
                    sb.append(" ");
                }
            }
            sb.append("\n");
        }
        sb.append("Bot 1 Captures: ")
                .append(bot1Captures)
                .append("   ")
                .append("Bot 2 Captures: ")
                .append(bot2Captures)
                .append("\n");
        return sb.toString();
    }
}
